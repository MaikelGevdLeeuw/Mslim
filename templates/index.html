<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Permit Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-10 text-sm">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow space-y-6">

    <!-- Navigatie -->
    <div class="bg-gray-800 text-white px-4 py-2 flex justify-between items-center rounded mb-6">
      <div class="space-x-4">
        <a href="/" class="hover:underline">Permits</a>
        <a href="/assets" class="hover:underline">Assets</a>
        <a href="/home" class="hover:underline">Home</a>
        <a href="/shift" class="hover:underline">Shift</a>
      </div>
      <div>
        Ingelogd als <strong>{{ session['user'] }}</strong> |
        <a href="/logout" class="text-red-300 hover:underline">Uitloggen</a>
      </div>
    </div>

    <h1 class="text-xl font-bold">Permit Aanvragen</h1>
    <form method="POST" action="/submit" class="grid grid-cols-2 gap-4 bg-gray-100 p-4 rounded">
      <div>
        <label>Categorie</label>
        <select name="category" id="category-select" required class="w-full border p-1 rounded">
          <option value="">Selecteer categorie</option>
          {% for c in assets | map(attribute='category') | unique %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label>Asset</label>
        <select name="asset" id="asset-select" required class="w-full border p-1 rounded">
          <option value="">Selecteer eerst een categorie</option>
        </select>
      </div>

      <div>
        <label>Locatie</label>
        <input name="area" id="area-field" readonly class="w-full border p-1 rounded bg-gray-200">
      </div>

      <div>
        <label>Site</label>
        <input name="site" id="site-field" readonly class="w-full border p-1 rounded bg-gray-200">
      </div>

      <div>
        <label>Verdieping</label>
        <input name="floor" required class="w-full border p-1 rounded">
      </div>

      <div>
        <label>Kamer</label>
        <input name="room" required class="w-full border p-1 rounded">
      </div>

      <div>
        <label>Datum</label>
        <input type="date" name="date" required class="w-full border p-1 rounded">
      </div>

      <div>
        <label>Tijd</label>
        <input type="time" name="time" required class="w-full border p-1 rounded">
      </div>

      <div>
        <label>Type werk</label>
        <input name="type" required class="w-full border p-1 rounded">
      </div>

      <div>
        <label>CHG nummer</label>
        <input name="chg" class="w-full border p-1 rounded">
      </div>

      <div>
        <label>ISO</label>
        <input name="iso" class="w-full border p-1 rounded">
      </div>

      <div class="col-span-2">
        <button class="bg-blue-600 text-white px-4 py-2 rounded" type="submit">Permit Aanvragen</button>
      </div>
    </form>

    <!-- Vandaag openstaande permits -->
    <h2 class="text-lg font-semibold mt-10">Permits vandaag</h2>
    <table class="w-full text-left border mt-2">
      <thead>
        <tr class="bg-gray-200">
          <th class="p-2 border">Nummer</th>
          <th class="p-2 border">Datum</th>
          <th class="p-2 border">Tijd</th>
          <th class="p-2 border">Categorie</th>
          <th class="p-2 border">Asset</th>
          <th class="p-2 border">Ruimte</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Engineer</th>
        </tr>
      </thead>
      <tbody>
        {% for p in today_permits %}
        <tr>
          <td class="border px-2">{{ p.number }}</td>
          <td class="border px-2">{{ p.date }}</td>
          <td class="border px-2">{{ p.time }}</td>
          <td class="border px-2">{{ p.category }}</td>
          <td class="border px-2">{{ p.asset }}</td>
          <td class="border px-2">{{ p.area }}</td>
          <td class="border px-2">{{ p.status }}</td>
          <td class="border px-2">{{ p.engineer }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>

  <!-- Javascript dropdown logica -->
  <script>
    const categorySelect = document.getElementById('category-select');
    const assetSelect = document.getElementById('asset-select');
    const areaField = document.getElementById('area-field');
    const siteField = document.getElementById('site-field');

    categorySelect.addEventListener('change', async () => {
      const category = categorySelect.value;
      if (!category) return;

      const res = await fetch(`/get_assets_by_category/${category}`);
      const assets = await res.json();

      assetSelect.innerHTML = '<option value="">Selecteer asset</option>';
      assets.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        opt.dataset.location = a.location;
        opt.dataset.site = a.site;
        assetSelect.appendChild(opt);
      });

      areaField.value = '';
      siteField.value = '';
    });

    assetSelect.addEventListener('change', () => {
      const selected = assetSelect.options[assetSelect.selectedIndex];
      areaField.value = selected.dataset.location || '';
      siteField.value = selected.dataset.site || '';
    });
  </script>
</body>
</html>
